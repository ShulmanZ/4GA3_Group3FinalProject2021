---
title: "Relationship Between Green Spaces and Mental Health in Toronto, ON"
#subtitle: "A subtitle"
thanks: "Paper submitted to complete the requirements of ENVSOCTY 4GA3 Applied Spatial Statistics"
author:
- name: Devon Sendler
  student_number: 400158561
- name: Lysha Boudreau-Pirsich
  student_number: 400085049
- name: Igancio De Ysasi Cabrera
  student_number: 400127387
- name: Owen Jarvis
  student_number: 400143944
- name: Zackary Shulman
  student_number: 400121210
subject: "ENVSOCTY 4GA3"
abstract: "This paper reports our analysis of the correlation between green space and mental health within Toronto, ON, and its relationship between income and age. Data was collected from the Open Ontario, statistics Canada, and Toronto Community Health."
keywords: "Mental, health, income, Toronto, Parks, spatial analysis"
date: "4/4/2021"
output:
  pdf_document:
    # The project-template-default.tex file was minimally adapted from Steven V. Miller's template for academic manuscripts. See:
    # http://svmiller.com/blog/2016/02/svm-r-markdown-manuscript/
    # https://github.com/svmiller/svm-r-markdown-templates/blob/master/svm-latex-ms.tex
    template: project-template-default.tex
bibliography: [bibliography.bib, packages.bib]
always_allow_html: true
---

<!--Chunks of code can have names; the chunk option "include" controls whether the chunk and its output are printed in the final document-->
```{r load-packages, include=FALSE}
rm(list = ls())
library(tidyverse)
library(ggmap)
library(geosphere)
library(sf)
library(plotly)
library(spdep)
library(geog4ga3)
library(readr)
install.packages(dplyr)
install.packages(spData)
library(dplyr)
library(spData)
library(raster)
```
```{r}
Variables_Final <- read_csv("4GA3_Project_Variables_Final.csv")
Neighbourbounds <- st_read("Neighbourhoods")
```

```{r}
remotes::install_github("Nowosad/spDataLarge")
library(spDataLarge)
```

```{r write-package-bib, include=FALSE}
# This function is used to write a bibliography for the `R` packages used in the paper
knitr::write_bib(file = 'packages.bib')
```

```{r}
Variables_Final <- read_csv("4GA3_Project_Variables_Final.csv")
Neighbourbounds <- st_read("Neighbourhoods_Boundaries")
Neighbourbounds_Centroids <- st_read("Neighbourhood_Centroids")
Parks <- st_read("parks-wgs84")
plot(st_geometry(Neighbourbounds))
plot(st_geometry(Parks))
data.frame(Neighbourbounds)
```

Fixing the names up for some of the fields (Kinda Clunky, if you can find a more efficient method please do!)
```{r}
names(Neighbourbounds)[names(Neighbourbounds) == 'Shape_Area'] <- 'Neighbourhood_Area'
names(Neighbourbounds)[names(Neighbourbounds) == 'Shape_Ar_1'] <- 'GS_Area'
names(Neighbourbounds)[names(Neighbourbounds) == 'Med_Indiv_'] <- 'Med_Ind_In'
names(Neighbourbounds)[names(Neighbourbounds) == 'Num_Househ'] <- 'Num_House'
names(Neighbourbounds)[names(Neighbourbounds) == 'Income_U50'] <- 'Income_U5000'
names(Neighbourbounds)[names(Neighbourbounds) == 'Income_500'] <- 'Income_5000to9999'
names(Neighbourbounds)[names(Neighbourbounds) == 'Income_100'] <- 'Income_10000to14999'
names(Neighbourbounds)[names(Neighbourbounds) == 'Income_150'] <- 'Income_15000to19999'
names(Neighbourbounds)[names(Neighbourbounds) == 'Income_200'] <- 'Income_20000to29999'
names(Neighbourbounds)[names(Neighbourbounds) == 'Income_300'] <- 'Income_30000to39999'
names(Neighbourbounds)[names(Neighbourbounds) == 'Income_400'] <- 'Income_40000to49999'
names(Neighbourbounds)[names(Neighbourbounds) == 'Income_501'] <- 'Income_50000to59999'
names(Neighbourbounds)[names(Neighbourbounds) == 'Income_600'] <- 'Income_60000to79999'
names(Neighbourbounds)[names(Neighbourbounds) == 'Income_800'] <- 'Income_80000to99999'
names(Neighbourbounds)[names(Neighbourbounds) == 'Income_101'] <- 'Income_100000to124999'
names(Neighbourbounds)[names(Neighbourbounds) == 'Income_125'] <- 'Income_125000to149999'
names(Neighbourbounds)[names(Neighbourbounds) == 'Income_151'] <- 'Income_150000Plus'
names(Neighbourbounds)[names(Neighbourbounds) == 'Non_immigr'] <- 'Non_Immigrants'
names(Neighbourbounds)[names(Neighbourbounds) == 'Shape_Ar_2'] <- 'GSArea_10Min_SA'
names(Neighbourbounds)[names(Neighbourbounds) == 'Shape_Ar_3'] <- 'GSArea_30Min_SA'
names(Neighbourbounds)[names(Neighbourbounds) == 'Shape_Ar_4'] <- 'GSArea_60Min_SA'

```


Mutate to add a field from SMA:
```{r}
Neighbourbounds <- Neighbourbounds %>%
  mutate(SMA_MH_PC_Tot = MH_PC_Tot)

```

#Spatial weights Matrix for data
```{r}
Neighbourbounds.sp <- as(Neighbourbounds,"Spatial")
Neighbourbounds.nb <- poly2nb(pl = Neighbourbounds.sp)
Neighbourbounds.w <- nb2listw(Neighbourbounds.nb)
```

Creating Buffers:
```{r}
#5 minute walk 
green_buff_5min = st_buffer(Neighbourbounds, dist = 410)
plot(st_geometry(green_buff_5min))

#10 minute walk 
green_buff_10min = st_buffer(Neighbourbounds, dist = 826)
plot(st_geometry(green_buff_10min))

#15 minute walk 
green_buff_15min = st_buffer(Neighbourbounds, dist = 1239)
plot(st_geometry(green_buff_15min))

#30 minute walk 
green_buff_30min = st_buffer(Neighbourbounds, dist = 2580)
plot(st_geometry(green_buff_30min))

#60 minute walk 
green_buff_60min = st_buffer(Neighbourbounds, dist = 5160)
plot(st_geometry(green_buff_60min))
```

Choropleth Maps of relevant data for this study:

```{r}
#Population Density 

ggplot() + 
  geom_sf(data = Neighbourbounds, 
          aes(fill = Census_Pop), color = NA) + 
  scale_fill_distiller(palette = "YlOrRd", direction = 1) + 
  labs(fill = "Population Density per Neighbourhood") + 
  theme(axis.text.x = element_blank(), 
        axis.text.y = element_blank())
```
A select few areas with over 40,000 people
```{r}
#Mental Health Cases Per Capita

ggplot() + 
  geom_sf(data = Neighbourbounds, 
          aes(fill = MH_PC_Tot), color = NA) + 
  scale_fill_distiller(palette = "YlOrRd", direction = 1) +  
  labs(fill = "Mental Health Cases Per Capita") + 
  theme(axis.text.x = element_blank(), 
        axis.text.y = element_blank())

ggplot() + 
  geom_sf(data = Neighbourbounds, 
          aes(fill = MH_PC_M), color = NA) + 
  scale_fill_distiller(palette = "YlOrRd", direction = 1) +  
  labs(fill = "Mental Health Cases Per Capita (Male)") + 
  theme(axis.text.x = element_blank(), 
        axis.text.y = element_blank())

ggplot() + 
  geom_sf(data = Neighbourbounds, 
          aes(fill = MH_PC_F), color = NA) + 
  scale_fill_distiller(palette = "YlOrRd", direction = 1) +  
  labs(fill = "Mental Health Cases Per Capita (Female)") + 
  theme(axis.text.x = element_blank(), 
        axis.text.y = element_blank())
```

```{r}
#Unemployment Rates 

ggplot() + 
  geom_sf(data = Neighbourbounds, 
          aes(fill = Unemploy_r), color = NA) + 
  scale_fill_distiller(palette = "YlOrRd", direction = 1) + 
  labs(fill = "Unemployment Rates (in %)") + 
  theme(axis.text.x = element_blank(), 
        axis.text.y = element_blank())
```
Correlation between mental health cases and unemployment rates are visible in 3 neighbourhoods.
```{r}
# Income Chloropleth Map

ggplot() + 
  geom_sf(data = Neighbourbounds, 
          aes(fill = Med_Indiv_), color = NA) + 
  scale_fill_distiller(palette = "YlOrRd", direction = 1) +  
  labs(fill = "Median Income (Individual) ") + 
  theme(axis.text.x = element_blank(), 
        axis.text.y = element_blank())

ggplot() + 
  geom_sf(data = Neighbourbounds, 
          aes(fill = Avg_Ind_In), color = NA) + 
  scale_fill_distiller(palette = "YlOrRd", direction = 1) +  
  labs(fill = "Average Income (Individual)") + 
  theme(axis.text.x = element_blank(), 
        axis.text.y = element_blank())
```

```{r}
#Living Situation 

ggplot() + 
  geom_sf(data = Neighbourbounds, 
          aes(fill = W_Rel), color = NA) + 
  scale_fill_distiller(palette = "YlOrRd", direction = 1) +  
  labs(fill = "Living with relatives") + 
  theme(axis.text.x = element_blank(), 
        axis.text.y = element_blank())

ggplot() + 
  geom_sf(data = Neighbourbounds, 
          aes(fill = W_Non_Rel), color = NA) + 
  scale_fill_distiller(palette = "YlOrRd", direction = 1) +  
  labs(fill = "Living with non-relatives ") + 
  theme(axis.text.x = element_blank(), 
        axis.text.y = element_blank())

ggplot() + 
  geom_sf(data = Neighbourbounds, 
          aes(fill = Alone), color = NA) + 
  scale_fill_distiller(palette = "YlOrRd", direction = 1) +  
  labs(fill = "Living alone ") + 
  theme(axis.text.x = element_blank(), 
        axis.text.y = element_blank())

```

Also, the median/average income choropleth maps show a relationship between low income and high mental health cases.
```{r}
#Age Proportion in each Neighbourhood 

ggplot(Neighbourbounds) + 
  geom_sf(aes(fill = cut_number((Age0to14 +
                                 Age15to24 +
                                 Age25to34 +
                                 Age35to44 +
                                 Age45to54 +
                                 Age55to64 +
                                 Age65to79 +
                                 Age80to99) / Census_Pop,8)),
          color = NA, 
          size = 0.1) +
  scale_fill_brewer(palette = "YlOrRd") +
  labs(fill = "Proportion of Age in Each Neighbourhood")

ggplot() + 
  geom_sf(data = Neighbourbounds, 
          aes(fill = Age0to14), color = NA) + 
  scale_fill_distiller(palette = "YlOrRd", direction = 1) +  
  labs(fill = "Age 0 to 14") + 
  theme(axis.text.x = element_blank(), 
        axis.text.y = element_blank())

ggplot() + 
  geom_sf(data = Neighbourbounds, 
          aes(fill = Age15to24), color = NA) + 
  scale_fill_distiller(palette = "YlOrRd", direction = 1) +  
  labs(fill = "Age 15 to 24") + 
  theme(axis.text.x = element_blank(), 
        axis.text.y = element_blank())

ggplot() + 
  geom_sf(data = Neighbourbounds, 
          aes(fill = Age25to34), color = NA) + 
  scale_fill_distiller(palette = "YlOrRd", direction = 1) +  
  labs(fill = "Age 25 to 34") + 
  theme(axis.text.x = element_blank(), 
        axis.text.y = element_blank())

ggplot() + 
  geom_sf(data = Neighbourbounds, 
          aes(fill = Age35to44), color = NA) + 
  scale_fill_distiller(palette = "YlOrRd", direction = 1) +  
  labs(fill = "Age 35 to 44") + 
  theme(axis.text.x = element_blank(), 
        axis.text.y = element_blank())

ggplot() + 
  geom_sf(data = Neighbourbounds, 
          aes(fill = Age45to54), color = NA) + 
  scale_fill_distiller(palette = "YlOrRd", direction = 1) +  
  labs(fill = "Age 45 to 54") + 
  theme(axis.text.x = element_blank(), 
        axis.text.y = element_blank())

ggplot() + 
  geom_sf(data = Neighbourbounds, 
          aes(fill = Age55to64), color = NA) + 
  scale_fill_distiller(palette = "YlOrRd", direction = 1) +  
  labs(fill = "Age 55 to 64") + 
  theme(axis.text.x = element_blank(), 
        axis.text.y = element_blank())

ggplot() + 
  geom_sf(data = Neighbourbounds, 
          aes(fill = Age65to79), color = NA) + 
  scale_fill_distiller(palette = "YlOrRd", direction = 1) +  
  labs(fill = "Age 65 to 79") + 
  theme(axis.text.x = element_blank(), 
        axis.text.y = element_blank())

ggplot() + 
  geom_sf(data = Neighbourbounds, 
          aes(fill = Age80to99), color = NA) + 
  scale_fill_distiller(palette = "YlOrRd", direction = 1) +  
  labs(fill = "Age 80 to 99") + 
  theme(axis.text.x = element_blank(), 
        axis.text.y = element_blank())
```

The overall findings from these maps point towards high unemployment rates and low median/average income being contributing factors that lead to high mental health cases.


Moran Test for Mental health cases:
```{r}
moran.test(Neighbourbounds$MH_PC_Tot, Neighbourbounds.w)

```
The p-value is low (~0.00016), therefore the data is spatially autocorellated

Moran Plot:
```{r}

MHTot_MP <- moran.plot(Neighbourbounds$MH_PC_Tot, Neighbourbounds.w)
```

his function is used to create local Moran maps:
```{r}
localmoran.map <- function(p = p, listw = listw, VAR = VAR, by = by){
  require(tidyverse)
  require(spdep)
  require(plotly)
  
  df_msc <- transmute(p,
                      key = p[[by]],
                      Z = (p[[VAR]] - mean(p[[VAR]])) / var(p[[VAR]]),
                      SMA = lag.listw(listw, Z),
                      Type = case_when(Z < 0 & SMA < 0 ~ "LL",
                                       Z > 0 & SMA > 0 ~ "HH",
                                       TRUE ~ "HL/LH"))
  
  local_I <- localmoran(p[[VAR]], listw)
  
  df_msc <- left_join(df_msc, 
                  data.frame(key = p[[by]], local_I))
  df_msc <- rename(df_msc, p.val = Pr.z...0.)
  
  plot_ly(df_msc) %>%
    add_sf(split = ~(p.val < 0.05), color = ~Type, colors = c("red", "khaki1", "dodgerblue", "dodgerblue4")) 
}
```

This function is used to create $G_i^*$ maps:
```{r}
gistar.map <- function(p = p, listw = listw, VAR = VAR, by = by){
  require(tidyverse)
  require(spdep)
  require(sf)
  require(plotly)
  
  p <- mutate(p, key = p[[by]])
  
  df.lg <- localG(p[[VAR]], listw)
  df.lg <- as.numeric(df.lg)
  df.lg <- data.frame(Gstar = df.lg, p.val = 2 * pnorm(abs(df.lg), lower.tail = FALSE))
  
  df.lg <- mutate(df.lg, 
              Type = case_when(Gstar < 0 & p.val <= 0.05 ~ "Low Concentration",
                               Gstar > 0 & p.val <= 0.05 ~ "High Concentration",
                               TRUE ~ "Not Signicant"))

  p <- left_join(p, 
                  data.frame(key = p[[by]], df.lg))
  
  plot_ly(p) %>%
    add_sf(split = ~(p.val < 0.05), color = ~Type, colors = c("red", "dodgerblue", "gray"))
}
```

Creating a local Moran Map:
```{r}
localmoran.map(Neighbourbounds, Neighbourbounds.w, "MH_PC_Tot", by = "NAME")
```

Creating GiStar MAp:
```{r}
gistar.map(Neighbourbounds, Neighbourbounds.w, "MH_PC_Tot", by = "NAME")
```



```{r calculate-spatial-moving-averages, include=FALSE}


MHPCTot.sma <- lag.listw(Neighbourbounds.w, Neighbourbounds$SMA_MH_PC_Tot)

simulation_1 <- sample(Neighbourbounds$SMA_MH_PC_Tot)
simulation_1.sma <- lag.listw(Neighbourbounds.w, simulation_1)
simulation_2 <- sample(Neighbourbounds$SMA_MH_PC_Tot)
simulation_2.sma <- lag.listw(Neighbourbounds.w, simulation_2)
simulation_3 <- sample(Neighbourbounds$SMA_MH_PC_Tot)
simulation_3.sma <- lag.listw(Neighbourbounds.w, simulation_3)
simulation_4 <- sample(Neighbourbounds$SMA_MH_PC_Tot)
simulation_4.sma <- lag.listw(Neighbourbounds.w, simulation_4)
simulation_5 <- sample(Neighbourbounds$SMA_MH_PC_Tot)
simulation_5.sma <- lag.listw(Neighbourbounds.w, simulation_5)
#Add simulated landscapes to sf dataframe
Neighbourbounds$simulation_1 <- simulation_1
Neighbourbounds$simulation_2 <- simulation_2
Neighbourbounds$simulation_3 <- simulation_3
Neighbourbounds$simulation_4 <- simulation_4
Neighbourbounds$simulation_5 <- simulation_5
```

```{r}
#Add spatial moving averages to sf dataframe
Neighbourbounds$simulation_1.sma <- simulation_1.sma
Neighbourbounds$simulation_2.sma <- simulation_2.sma
Neighbourbounds$simulation_3.sma <- simulation_3.sma
Neighbourbounds$simulation_4.sma <- simulation_4.sma
Neighbourbounds$simulation_5.sma <- simulation_5.sma

#Create a new dataframe to compare original landscape to null landscapes
MH_PC_Tot2 <- Neighbourbounds %>% 
  # `transmute()` keeps only the spatial moving averages and geometry
  transmute(observed = MH_PC_Tot, 
         simulation_1,
         simulation_2,
         simulation_3,
         simulation_4,
         simulation_5,
         geometry) %>% 
  # `pivot_longer()` places all variables with the exception of `geometry` in a single column named `SMA` and creates a new variable called `VAR` with the names of the original columns (i.e., observed, simulation_1,...)
  pivot_longer(cols = -c(geometry, ends_with("sma")), names_to = "VAR", values_to = "values") %>%
  st_as_sf()

ggplot() + 
  geom_sf(data = MH_PC_Tot2, 
          aes(fill = values), color = NA) + 
  facet_wrap(~VAR, ncol = 3) +
  scale_fill_distiller(palette = "YlOrRd", direction = 1)+
  labs(fill = "Mental Health Cases per SMA") + 
  theme(axis.text.x = element_blank(), 
        axis.text.y = element_blank())

MH_PC_Tot2 <- MH_PC_Tot2 %>% 
  data.frame(Neighbourbounds %>% 
               st_drop_geometry() %>% # Drop the geometry because it is already available 
               # Select the original population density and the 5 null landscapes simulated from it.
               transmute(MHPCTot.sma,
                      simulation_1.sma,
                      simulation_2.sma,
                      simulation_3.sma,
                      simulation_4.sma,
                      simulation_5.sma,
               ) %>% # Pass the result to `pivot_longer()`  
               pivot_longer(cols = everything(), names_to = "VAR", values_to = "SMA") %>% # Copy all density variables to a single column, and create a new variable called `VAR` with the names of the original columns 
               select(SMA)) # Drop VAR from the the dataframe
```

Plots:
```{r}
ggplot(data = MH_PC_Tot2, 
       aes(x = values, 
           y = SMA,
           color = VAR)) +
  geom_point(alpha = 0.1) +
  geom_abline(slope = 1, intercept = 0, linetype = "dashed") +
  # Add a fitted line to the plots
  geom_smooth(formula = y ~ x,
              method = "lm") +
  coord_equal() +
  xlab("Mental Helath cases per Neighbourhood") +
  ylab("Spatial lag of mental health cases per neighbourhood") +
  facet_wrap(~ VAR, ncol = 3)

Neighbourhood_centroids <- st_centroid(Neighbourbounds_Centroids) %>% 
  st_coordinates()

Neighbourhood_centroids.knb <- knn2nb(knearneigh(Neighbourhood_centroids, k = 3))
plot(Neighbourbounds.sp, border = "gray")
plot(Neighbourhood_centroids.knb, Neighbourhood_centroids, col = "red", add = TRUE)
```
```


<!--This create a page break, i.e., starts a new page-->
<!--\newpage-->

<!-- 
To cite references in your bibliography.bib file, use [@item] if you want it to be cited in brackets, or @item if you want it to be cited as Name (year). If you want to cite various items in brackets, separate them with semicolons [@item1; @item2]
-->

<!--Use "#" for section headers-->
# Introduction
	As the current global population rises over 7.8 billion people, more people move from rural towns and settlements towards bigger metropolises. While big cities make services like healthcare, sanitation, or education (among others) more accessible to people, not everything about the move is positive. Exposure and access to green spaces, especially during the earlier years of a child’s development, has been demonstrated to have an impact on the risk of developing psychiatric disorders and mental health in general. A study by  Engeman et al. (2019)  included over 900,000 people from Denmark, comparing the Normalized Difference Vegetation Index obtained from satellite imagery with incidence rate ratios of developing psychiatric disorders. Engeman et al. (2019) proved a 15 to 55% higher risk of mental health deterioration in residents when comparing areas with the lowest and highest levels of green space.
The need to understand these links between mental health and green spaces becomes increasingly important as cities continue growing, highlighting the relevance of approaching the development of new urban infrastructure with natural spaces in mind. Callaghan et al. (2020) concluded that 23 of their 25 cross-sectional studies showed a positive relationship between mentally healthy population and green space characteristics. The evidence is there, and for the purpose of this research, we want to focus on the city of Toronto. The city’s surface area is 13% green space (open spaces, parks, community gardens, etc). Despite the seemingly overwhelming evidence for this positive relationship of good mental health and green spaces, the quality, cleanliness, location, and accessibility to these spaces also play a role in its users’ mental health. This being said, there have also been studies interested in highlighting these issues, which we hope to add with the proposed spatial statistics research project. 
As Scottish-American naturalist John Muir stated at the turn of the 19th century, ‘thousands of tired, nerve-shaken, over-civilized people are beginning to find out that going to the mountains is going home’. Rather than their presence, it may be the way natural spaces are distributed in today’s urban metropolitan areas that dictates their impact on city dwellers. 

# Study area



<!--Chunk option eval controls whether a chunk is evaluated when the document is executed; set to false to avoid running. It can still be manually run-->


<!--Chunk option echo controls whether the code is displayed in the output. The results of the chunk are displayed.
Chunk option fig.cap is used to give the figure a caption; we can add a label that we can refer to in the text as \ref{fig:counties-ky}, and then the figures will be automatically numbered.-->

# Data

The project’s data comes from several sources. Neighbourhood boundaries and green space areas come from Open Toronto, a data portal containing publicly available information on Toronto, and Statistics Canada from 2011. The city is broken down into 140 distinct neighbourhoods, allowing us to analyze the relationship in great detail. Presuming residents are most likely to utilize green spaces that are easily accessible to them,  a neighbourhood level spatial scale is appropriate. data Toronto Community Health profiles provide a neighbourhood-level breakdown of the annual rate of hospitalizations of Mental Health Conditions for those over 20. This data is averaged annually from 2012 to 2014. This is provided for males, females, and the overall population. As well, the data provided describes whether the hospitalizations for mental health conditions in a given neighbourhood are higher than, lower than, or not significantly different from the City of Toronto overall rate. This is done at a 95% confidence interval. Mental health is often a difficult topic to measure, so we decided that hospital admissions, a clear and quantifiable variable, was a good indicator of mental health within a neighbourhood. We plan to compare the numerical number of mental-health related hospital admissions to the percentage of a neighbourhood that is classified as green space. As well, we will compare the status of a neighbourhood (i.e. significantly higher than, significantly lower than, or not significantly different than Toronto’s average mental health admission rate) to the percentage of green spaces. Utilizing these datasets will help us determine if there is a relationship between the availability of green spaces and the mental health of Torontonians. 
# Methods

Proposed Analysis Methods:



# Results


<!--We can include inline calculations in the text by using r code as shown in the paragraph below-->


# Analysis

#Here we look at each figure we have created and how it affects our conclusion

# Conclusion

# References
https://open.toronto.ca/
https://www12.statcan.gc.ca/census-recensement/2011/dp-pd/prof/details/page.cfm?Lang=E&Geo1=CMA&Code1=535&Geo2=PR&Code2=01&Data=Count&SearchText=Toronto&SearchType=Begins&SearchPR=01&B1=All&Custom=&TABID=1


