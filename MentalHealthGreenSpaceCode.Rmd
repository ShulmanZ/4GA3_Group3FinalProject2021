---
title: "Relationship Between Green Spaces and Mental Health in Toronto, ON"
#subtitle: "A subtitle"
thanks: "Paper submitted to complete the requirements of ENVSOCTY 4GA3 Applied Spatial Statistics"
author:
- name: Devon Sendler
  student_number: 400158561
- name: Lysha Boudreau-Pirsich
  student_number: 400085049
- name: Igancio De Ysasi Cabrera
  student_number: 400127387
- name: Owen Jarvis
  student_number: 400143944
- name: Zackary Shulman
  student_number: 400121210
subject: "ENVSOCTY 4GA3"
abstract: "This paper reports our analysis of the correlation between green space and mental health within Toronto, ON, and its relationship between income and age. Data was collected from the Open Ontario, statistics Canada, and Toronto Community Health."
keywords: "Mental, health, income, Toronto, Parks, spatial analysis"
date: "4/4/2021"
output:
  pdf_document:
    # The project-template-default.tex file was minimally adapted from Steven V. Miller's template for academic manuscripts. See:
    # http://svmiller.com/blog/2016/02/svm-r-markdown-manuscript/
    # https://github.com/svmiller/svm-r-markdown-templates/blob/master/svm-latex-ms.tex
    template: project-template-default.tex
bibliography: [bibliography.bib, packages.bib]
always_allow_html: true
---

<!--Chunks of code can have names; the chunk option "include" controls whether the chunk and its output are printed in the final document-->
```{r load-packages, include=FALSE}
rm(list = ls())
library(tidyverse)
library(ggmap)
library(geosphere)
library(sf)
library(plotly)
library(spdep)
library(geog4ga3)
library(readr)
library(scales)
```
```{r}
Variables_Final <- read_csv("4GA3_Project_Variables_Final.csv")
Neighbourbounds <- st_read("Neighbourhoods")
```




```{r write-package-bib, include=FALSE}
# This function is used to write a bibliography for the `R` packages used in the paper
knitr::write_bib(file = 'packages.bib')
```
#INTRODUCTION
  When is the last time you enjoyed a stroll in the park, a casual game of catch, or simply took your dog for a walk by a green space down your street? Hopefully it hasn’t been too long! Undoubtedly, parks and green spaces have become absolutely essential areas in our cities (Shanahan et al., 2015), a place to disconnect from the stressors of everyday life and, perhaps, connect back to nature, with a neighbour, friends, or one’s inner peace. They provide fundamental services such as physical activity, meditation, social interaction, or simply a moment away from the hustle and bustle of modern cities such as Toronto, the focus of the present paper. Green spaces like Central Park in New York City (USA) or High Park in Toronto (ON) are millionaire investments that require careful planning and maintenance for the remainder from the moment they are inaugurated (and even prior to that). They must have a clear net positive effect on the population if they were deemed as feasible projects. As population rises and cities continue growing exponentially, public services such as city parks and other green spaces must be planned in ways that ensure equitable access to all inhabitants, if they are to be beneficial to the communities they serve (Nutsford et al., 2013). 
The present paper aims to determine the relationship between green-space availability and mental health in Toronto, ON, Canada. The specific goal of our project is to investigate the relationship between the availability of different green space types including playgrounds, parks, and community gardens; and their effect on mental health admission rates in Toronto neighbourhoods. To determine the existence (or lack thereof) of this relationship this project will firstly provide a comprehensive review of the available literature on links between green space and mental health, and walking distance trends in cities. Following the literature review, the data utilized in this study will be outlined, along with the methodology and statistical analysis used to accept  or reject the null hypothesis. Our running hypothesis will expect there to be a clear negative correlation between green space availability and mental health hospital admissions per neighbourhoods in Toronto. Other aspects and relationships will be explored, such as the socioeconomic groups most affected by different availability of green spaces. Finally, the present paper will present final remarks, along with recommendations on future studies and urban planning, specifically in the city of Toronto, ON.

#BACKGROUND
  Plenty of research is constantly being conducted to determine the effect of green spaces on population’s physical and mental health, as well as on the parameters that ensure equitable access to these areas. Are there certain socioeconomic groups more affected by their accessibility to parks? Does sex play a role in these relationships? Does the city of Toronto, widely regarded as one of the best places to live in worldwide, show correlation between green space accessibility and Torontonians’ mental health? Some of these questions have been answered by the existing literature, and some others, specific to Toronto (ON), we hope to shed light on with the present paper.


  Contact with natural environments including green spaces has been associated with improved perceived and objective health outcomes and wellbeing (Alcock et al., 2014 and James et al., 2015;). Science attributes many benefits to green spaces, including increased physical activity, reducing psychological stress, anxiety and depression, increasing social contacts and cohesion and reducing exposure to environmental hazards such as air pollution (Dadvand et al. 2015, 2016). Lopes et al. (2020) demonstrate the positive effects of walking in nature. As they suggest, a walk as short as 30 minutes in a setting with natural elements, such as a park, elicits a feeling of awe and consequently draws people away from themselves, preventing rumination and its negative health effects (related to stress and thus high cortisol levels). In this study, researchers compared the effects of walking in nature with the same type of walk (group and duration) except in an urban setting, through the city. This study adds to the scientific consensus that access to natural environments, especially within an urban environment, yields important benefits to the mental health capital of cities and countries. Dadvand et al. (206) suggest a more relevant effect of green spaces on mental health status in males under the age of 65. For the purpose of our study we will determine whether different sex or age groups experience different mental health outcomes with proximity or accessibility to green spaces in Toronto, as observed by Dadvand et al. (2016) in Barcelona.  While science does not correlate living in a greener neighbourhood with any wellbeing outcomes, on the other hand it does suggest positive health outcomes for those who visited nature more than once a week (Martin et al., 2020). Martin et al. 2020 adds to the scientific consensus of positive health-nature relationships, suggesting that “detachment from the natural world may be a factor in poor mental and physical health”. In the present study we aim to determine whether parameters like distance and size of natural areas within Toronto (which affect accessibility) have an impact on the mental health of its population. Rigolon et al (2021) aim to determine the strength of associations between green-space and health of advantaged and disadvantaged groups. This research is relevant for the purpose of the present study on the associations between green-space and mental health in Toronto. The city has been a focus of this sort of science already, with papers such as Hassen (2016) pointing out the challenges of determining which characteristics of green spaces do affect Torontonians’ mental health, such as quality and accessibility of the parks.
Determining which socioeconomic groups have a greater health dependency on accessibility to green-space can help in future urban planning and park allocation within cities. Rigolon et al. 2021 demonstrate that people of lower socioeconomic status show more beneficial effects to park accessibility than high-income households. The literature is clear, with multiple papers pointing out clear correlations between higher levels of green space and healthier populations (Richardson et al., 2013; van den Berg et al., 2016; Barton & Rogerson, 2017;  Engeman et al., 2019; Callaghan et al., 2020 ). An important aspect of the analysis carried out for the purpose of our study on Toronto were buffers created around neighbourhoods’ centroids. These buffers would represent the walk time an average person would walk towards a park, within or outside their neighbourhood. 

# Study area
The affect of greenspace on mental health was conducted at the census tract level within Toronto. In order to analyze green space we overlayed a shapefile containing the census tracts with a shapefile containing the area in Km^2 of Toronto' green spaces. Toronto was chosen as our study site due to the highly variable greenspace and its abundant open data sources. A high variability in green space was important for this study as it allows us to view results at the extremes (i.e. virtually no nearby green space -> alot of nearby greenspace) while still having enough census tracts to account for any significant deviations such as disproportionately massive parks.

# Data
The project’s data comes from several sources. Neighbourhood boundaries and green space areas come from Open Toronto, a data portal containing publicly available information on Toronto, and Statistics Canada from 2011. The city is broken down into 140 distinct neighbourhoods, allowing us to analyze the relationship in great detail. Presuming residents are most likely to utilize green spaces that are easily accessible to them,  a neighbourhood level spatial scale is appropriate. data Toronto Community Health profiles provide a neighbourhood-level breakdown of the annual rate of hospitalizations of Mental Health Conditions for those over 20. This data is averaged annually from 2012 to 2014. This is provided for males, females, and the overall population. As well, the data provided describes whether the hospitalizations for mental health conditions in a given neighbourhood are higher than, lower than, or not significantly different from the City of Toronto overall rate. This is done at a 95% confidence interval. Mental health is often a difficult topic to measure, so we decided that hospital admissions, a clear and quantifiable variable, was a good indicator of mental health within a neighbourhood. We plan to compare the numerical number of mental-health related hospital admissions to the percentage of a neighbourhood that is classified as green space. As well, we will compare the status of a neighbourhood (i.e. significantly higher than, significantly lower than, or not significantly different than Toronto’s average mental health admission rate) to the percentage of green spaces. Utilizing these datasets will help us determine if there is a relationship between the availability of green spaces and the mental health of Torontonians.

 
# Methods
This study uses Rstudio to conduct a series of data processes to visualize and find a significant correlation in several variables including wealth, age, and distance to green space for Toronto, ON. The independent variable in this study is the mental health data that measures annual hospitilization rates for the population of Toronto. This study conducts area data analysis using chloropleth maps to visualize trends and patterns in the data, scatterplots, and regression analyses to determine relationships between mental health and the dependent variables.

#Results
To begin this study we had to overlay a green space shapefile with the census shapefile. The green space data was originally in absolute km^2 but was changed to percentage within each census tract. Centroids were added to each census subdivision to determine the distance between each neighbourhood. 
```{r}
Variables_Final <- read_csv("4GA3_Project_Variables_Final.csv")
Neighbourbounds <- st_read("Neighbourhoods_Boundaries")
Neighbourbounds_Centroids <- st_read("Neighbourhood_Centroids")
Parks <- st_read("CITY_GREEN_SPACE_NAD1983")
plot(st_geometry(Neighbourbounds))
plot(st_geometry(Parks))
data.frame(Neighbourbounds)
Parks.df <- data.frame(Parks)
```


Fixing the names up for some of the fields (Kinda Clunky, if you can find a more efficient method please do!)
```{r}
names(Neighbourbounds)[names(Neighbourbounds) == 'Shape_Area'] <- 'Neighbourhood_Area'
names(Neighbourbounds)[names(Neighbourbounds) == 'Shape_Ar_1'] <- 'GS_Area'
names(Neighbourbounds)[names(Neighbourbounds) == 'Med_Indiv_'] <- 'Med_Ind_In'
names(Neighbourbounds)[names(Neighbourbounds) == 'Num_Househ'] <- 'Num_House'
names(Neighbourbounds)[names(Neighbourbounds) == 'Income_U50'] <- 'Income_U5000'
names(Neighbourbounds)[names(Neighbourbounds) == 'Income_500'] <- 'Income_5000to9999'
names(Neighbourbounds)[names(Neighbourbounds) == 'Income_100'] <- 'Income_10000to14999'
names(Neighbourbounds)[names(Neighbourbounds) == 'Income_150'] <- 'Income_15000to19999'
names(Neighbourbounds)[names(Neighbourbounds) == 'Income_200'] <- 'Income_20000to29999'
names(Neighbourbounds)[names(Neighbourbounds) == 'Income_300'] <- 'Income_30000to39999'
names(Neighbourbounds)[names(Neighbourbounds) == 'Income_400'] <- 'Income_40000to49999'
names(Neighbourbounds)[names(Neighbourbounds) == 'Income_501'] <- 'Income_50000to59999'
names(Neighbourbounds)[names(Neighbourbounds) == 'Income_600'] <- 'Income_60000to79999'
names(Neighbourbounds)[names(Neighbourbounds) == 'Income_800'] <- 'Income_80000to99999'
names(Neighbourbounds)[names(Neighbourbounds) == 'Income_101'] <- 'Income_100000to124999'
names(Neighbourbounds)[names(Neighbourbounds) == 'Income_125'] <- 'Income_125000to149999'
names(Neighbourbounds)[names(Neighbourbounds) == 'Income_151'] <- 'Income_150000Plus'
names(Neighbourbounds)[names(Neighbourbounds) == 'Non_immigr'] <- 'Non_Immigrants'
names(Neighbourbounds)[names(Neighbourbounds) == 'Shape_Ar_2'] <- 'GSArea_10Min_SA'
names(Neighbourbounds)[names(Neighbourbounds) == 'Shape_Ar_3'] <- 'GSArea_30Min_SA'
names(Neighbourbounds)[names(Neighbourbounds) == 'Shape_Ar_4'] <- 'GSArea_60Min_SA'

```


Mutate to add a field from SMA:
```{r}
Neighbourbounds <- Neighbourbounds %>%
  mutate(SMA_MH_PC_Tot = MH_PC_Tot)

```

#Spatial weights Matrix for data
```{r}
Neighbourbounds.sp <- as(Neighbourbounds,"Spatial")
Neighbourbounds.nb <- poly2nb(pl = Neighbourbounds.sp)
Neighbourbounds.w <- nb2listw(Neighbourbounds.nb)
```

Creating Buffers:
```{r}
#5 minute walk 
green_buff_5min = st_buffer(Neighbourbounds, dist = 410)
plot(st_geometry(green_buff_5min))

#10 minute walk 
green_buff_10min = st_buffer(Neighbourbounds, dist = 826)
plot(st_geometry(green_buff_10min))

#15 minute walk 
green_buff_15min = st_buffer(Neighbourbounds, dist = 1239)
plot(st_geometry(green_buff_15min))

#30 minute walk 
green_buff_30min = st_buffer(Neighbourbounds, dist = 2580)
plot(st_geometry(green_buff_30min))

#60 minute walk 
green_buff_60min = st_buffer(Neighbourbounds, dist = 5160)
plot(st_geometry(green_buff_60min))
```




Choropleth Maps of relevant data for this study:

```{r}
#Population Density based on a total population of 2615060

options(scipen=10000)

ggplot(Neighbourbounds) + 
  geom_sf(aes(fill = cut_number(((Census_Pop/Neighbourhood_Area)*1000000),8)),
          color = NA, 
          size = 0.1) +
  scale_fill_brewer(palette = "YlOrRd") +
  labs(fill = "Population Density per Neighbourhood (people per km squared")



ggplot() + 
  geom_sf(data = Neighbourbounds, 
          aes(fill = Census_Pop), color = NA) + 
  scale_fill_distiller(palette = "YlOrRd", direction = 1) + 
  labs(fill = "Population Density per Neighbourhood") + 
  theme(axis.text.x = element_blank(), 
        axis.text.y = element_blank())
```
A select few areas with over 40,000 people
```{r}
#Mental Health Cases Per Capita

options(scipen=10000)

ggplot() + 
  geom_sf(data = Neighbourbounds, 
          aes(fill = MH_PC_Tot), color = NA) + 
  scale_fill_distiller(palette = "YlOrRd", direction = 1) +  
  labs(fill = "Mental Health Cases Per Capita") + 
  theme(axis.text.x = element_blank(), 
        axis.text.y = element_blank())




ggplot(Neighbourbounds) + 
  geom_sf(aes(fill = cut_number((MH_PC_Tot),8)),
          color = NA, 
          size = 0.1) +
  scale_fill_brewer(palette = "YlOrRd") +
  labs(fill = "Mental Health Cases per Capita in each Neighbourhood (Total)")


ggplot() + 
  geom_sf(data = Neighbourbounds, 
          aes(fill = MH_PC_M), color = NA) + 
  scale_fill_distiller(palette = "YlOrRd", direction = 1) +  
  labs(fill = "Mental Health Cases Per Capita (Male)") + 
  theme(axis.text.x = element_blank(), 
        axis.text.y = element_blank())


ggplot(Neighbourbounds) + 
  geom_sf(aes(fill = cut_number((MH_PC_M),8)),
          color = NA, 
          size = 0.1) +
  scale_fill_brewer(palette = "YlOrRd") +
  labs(fill = "Mental Health Cases per Capita in each Neighbourhood (Males)")

ggplot() + 
  geom_sf(data = Neighbourbounds, 
          aes(fill = MH_PC_F), color = NA) + 
  scale_fill_distiller(palette = "YlOrRd", direction = 1) +  
  labs(fill = "Mental Health Cases Per Capita (Female)") + 
  theme(axis.text.x = element_blank(), 
        axis.text.y = element_blank())



ggplot(Neighbourbounds) + 
  geom_sf(aes(fill = cut_number((MH_PC_F),8)),
          color = NA, 
          size = 0.1) +
  scale_fill_brewer(palette = "YlOrRd") +
  labs(fill = "Mental Health Cases per Capita in each Neighbourhood (Females)")
```

```{r}
#Unemployment Rates 

options(scipen=10000)

ggplot() + 
  geom_sf(data = Neighbourbounds, 
          aes(fill = Unemploy_r), color = NA) + 
  scale_fill_distiller(palette = "YlOrRd", direction = 1) + 
  labs(fill = "Unemployment Rates (in %)") + 
  theme(axis.text.x = element_blank(), 
        axis.text.y = element_blank())
```
Correlation between mental health cases and unemployment rates are visible in 3 neighbourhoods.
```{r}
# Income Chloropleth Map

options(scipen=10000)

ggplot() + 
  geom_sf(data = Neighbourbounds, 
          aes(fill = Med_Ind_In), color = NA) + 
  scale_fill_distiller(palette = "YlOrRd", direction = 1) +  
  labs(fill = "Median Income (Individual) ") + 
  theme(axis.text.x = element_blank(), 
        axis.text.y = element_blank())

ggplot() + 
  geom_sf(data = Neighbourbounds, 
          aes(fill = Avg_Ind_In), color = NA) + 
  scale_fill_distiller(palette = "YlOrRd", direction = 1) +  
  labs(fill = "Average Income (Individual)") + 
  theme(axis.text.x = element_blank(), 
        axis.text.y = element_blank())
```

```{r}
#Living Situation 


ggplot(Neighbourbounds) + 
  geom_sf(aes(fill = cut_number(((W_Rel) / Census_Pop)*100,8)),
          color = NA, 
          size = 0.1) +
  scale_fill_brewer(palette = "YlOrRd") +
  labs(fill = "Percent of Residents Living with Relatives")

ggplot(Neighbourbounds) + 
  geom_sf(aes(fill = cut_number(((W_Non_Rel) / Census_Pop)*100,8)),
          color = NA, 
          size = 0.1) +
  scale_fill_brewer(palette = "YlOrRd") +
  labs(fill = "Percent of Residents Living non-Relatives")



ggplot(Neighbourbounds) + 
  geom_sf(aes(fill = cut_number(((Alone) / Census_Pop)*100,8)),
          color = NA, 
          size = 0.1) +
  scale_fill_brewer(palette = "YlOrRd") +
  labs(fill = "Percent of Residents Living Alone")


```

Mutate to make data in km squared:

```{r}
Neighbourbounds <- Neighbourbounds %>%
  mutate(Area_5min_km = Area_5min/1000000,
         Area_10min_km = Area_10min/1000000,
         Area_15min_km = Area_15min/1000000,
         Area_30min_km = Area_30min/1000000,
         Area_60min_km = Area_60min/1000000)

```



Chloropleth maps for how much green space is available within buffer distance:
```{r}
options(scipen=10000)

#Continuous Maps:



ggplot() + 
  geom_sf(data = Neighbourbounds, 
          aes(fill = Area_5min_km), color = NA) + 
  scale_fill_distiller(palette = "YlOrRd", direction = 1) +  
  labs(fill = "Amount of Green Space within 5 Minute Walk (km squared) ") + 
  theme(axis.text.x = element_blank(), 
        axis.text.y = element_blank())


ggplot() + 
  geom_sf(data = Neighbourbounds, 
          aes(fill = Area_10min_km), color = NA) + 
  scale_fill_distiller(palette = "YlOrRd", direction = 1) +  
  labs(fill = "Amount of Green Space within 10 Minute Walk (km squared) ") + 
  theme(axis.text.x = element_blank(), 
        axis.text.y = element_blank())


ggplot() + 
  geom_sf(data = Neighbourbounds, 
          aes(fill = Area_15min_km), color = NA) + 
  scale_fill_distiller(palette = "YlOrRd", direction = 1) +  
  labs(fill = "Amount of Green Space within 15 Minute Walk (km squared) ") + 
  theme(axis.text.x = element_blank(), 
        axis.text.y = element_blank())


ggplot() + 
  geom_sf(data = Neighbourbounds, 
          aes(fill = Area_30min_km), color = NA) + 
  scale_fill_distiller(palette = "YlOrRd", direction = 1) +  
  labs(fill = "Amount of Green Space within 30 Minute Walk (km squared) ") + 
  theme(axis.text.x = element_blank(), 
        axis.text.y = element_blank())


ggplot() + 
  geom_sf(data = Neighbourbounds, 
          aes(fill = Area_60min_km), color = NA) + 
  scale_fill_distiller(palette = "YlOrRd", direction = 1) +  
  labs(fill = "Amount of Green Space within 60 Minute Walk (km squared) ") + 
  theme(axis.text.x = element_blank(), 
        axis.text.y = element_blank())


#Discrete Maps


ggplot(Neighbourbounds) + 
  geom_sf(aes(fill = cut_number(((Area_5min)/1000000),8)),
          color = NA, 
          size = 0.1) +
  scale_fill_brewer(palette = "YlOrRd") +
  labs(fill = "Amount of green space within a 5 minute walk (km^2)")





ggplot(Neighbourbounds) + 
  geom_sf(aes(fill = cut_number(((Area_10min_km)/1000000),8)),
          color = NA, 
          size = 0.1) +
  scale_fill_brewer(palette = "YlOrRd") +
  labs(fill = "Amount of green space within a 10 minute walk (km^2)")



ggplot(Neighbourbounds) + 
  geom_sf(aes(fill = cut_number(((Area_15min)/1000000),8)),
          color = NA, 
          size = 0.1) +
  scale_fill_brewer(palette = "YlOrRd") +
  labs(fill = "Amount of green space within a 15 minute walk (km^2)")






ggplot(Neighbourbounds) + 
  geom_sf(aes(fill = cut_number(((Area_30min)/1000000),8)),
          color = NA, 
          size = 0.1) +
  scale_fill_brewer(palette = "YlOrRd") +
  labs(fill = "Amount of green space within a 30 minute walk (km^2)")




ggplot(Neighbourbounds) + 
  geom_sf(aes(fill = cut_number(((Area_60min)/1000000),8)),
          color = NA, 
          size = 0.1) +
  scale_fill_brewer(palette = "YlOrRd") +
  labs(fill = "Amount of green space within a 60 minute walk (km^2)")

```

```{r}
#Age Proportion in each Neighbourhood 

ggplot(Neighbourbounds) + 
  geom_sf(aes(fill = cut_number((
                                 Age45to54 +
                                 Age55to64 +
                                 Age65to79 +
                                 Age80to99) / Census_Pop,8)),
          color = NA, 
          size = 0.1) +
  scale_fill_brewer(palette = "YlOrRd") +
  labs(fill = "Proportion 45+  in Each Neighbourhood")


ggplot(Neighbourbounds) + 
  geom_sf(aes(fill = cut_number((
                                 Age65to79 +
                                 Age80to99) / Census_Pop,8)),
          color = NA, 
          size = 0.1) +
  scale_fill_brewer(palette = "YlOrRd") +
  labs(fill = "Proportion 65+  in Each Neighbourhood")

```

The overall findings from these maps point towards high unemployment rates and low median/average income being contributing factors that lead to high mental health cases.


Moran Test for Mental health cases:
```{r}
moran.test(Neighbourbounds$MH_PC_Tot, Neighbourbounds.w)

```
The p-value is low (~0.00016), therefore the data is spatially autocorellated

Moran Plot:
```{r}

MHTot_MP <- moran.plot(Neighbourbounds$MH_PC_Tot, Neighbourbounds.w)
```

his function is used to create local Moran maps:
```{r}
localmoran.map <- function(p = p, listw = listw, VAR = VAR, by = by){
  require(tidyverse)
  require(spdep)
  require(plotly)
  
  df_msc <- transmute(p,
                      key = p[[by]],
                      Z = (p[[VAR]] - mean(p[[VAR]])) / var(p[[VAR]]),
                      SMA = lag.listw(listw, Z),
                      Type = case_when(Z < 0 & SMA < 0 ~ "LL",
                                       Z > 0 & SMA > 0 ~ "HH",
                                       TRUE ~ "HL/LH"))
  
  local_I <- localmoran(p[[VAR]], listw)
  
  df_msc <- left_join(df_msc, 
                  data.frame(key = p[[by]], local_I))
  df_msc <- rename(df_msc, p.val = Pr.z...0.)
  
  plot_ly(df_msc) %>%
    add_sf(split = ~(p.val < 0.05), color = ~Type, colors = c("red", "khaki1", "dodgerblue", "dodgerblue4")) 
}
```


This function is used to create $G_i^*$ maps:
```{r}
gistar.map <- function(p = p, listw = listw, VAR = VAR, by = by){
  require(tidyverse)
  require(spdep)
  require(sf)
  require(plotly)
  
  p <- mutate(p, key = p[[by]])
  
  df.lg <- localG(p[[VAR]], listw)
  df.lg <- as.numeric(df.lg)
  df.lg <- data.frame(Gstar = df.lg, p.val = 2 * pnorm(abs(df.lg), lower.tail = FALSE))
  
  df.lg <- mutate(df.lg, 
              Type = case_when(Gstar < 0 & p.val <= 0.05 ~ "Low Concentration",
                               Gstar > 0 & p.val <= 0.05 ~ "High Concentration",
                               TRUE ~ "Not Signicant"))

  p <- left_join(p, 
                  data.frame(key = p[[by]], df.lg))
  
  plot_ly(p) %>%
    add_sf(split = ~(p.val < 0.05), color = ~Type, colors = c("red", "dodgerblue", "gray"))
}
```

Creating a local Moran Map:
```{r}
localmoran.map(Neighbourbounds, Neighbourbounds.w, "MH_PC_Tot", by = "NAME")
```

```{r}
localmoran.map(Neighbourbounds, Neighbourbounds.w, "Area_15min", by = "NAME")
```


Creating GiStar MAp:
```{r}
gistar.map(Neighbourbounds, Neighbourbounds.w, "MH_PC_Tot", by = "NAME")
```

```{r}
gistar.map(Neighbourbounds, Neighbourbounds.w, "Area_30min", by = "NAME")
```



```{r calculate-spatial-moving-averages, include=FALSE}


MHPCTot.sma <- lag.listw(Neighbourbounds.w, Neighbourbounds$SMA_MH_PC_Tot)

simulation_1 <- sample(Neighbourbounds$SMA_MH_PC_Tot)
simulation_1.sma <- lag.listw(Neighbourbounds.w, simulation_1)
simulation_2 <- sample(Neighbourbounds$SMA_MH_PC_Tot)
simulation_2.sma <- lag.listw(Neighbourbounds.w, simulation_2)
simulation_3 <- sample(Neighbourbounds$SMA_MH_PC_Tot)
simulation_3.sma <- lag.listw(Neighbourbounds.w, simulation_3)
simulation_4 <- sample(Neighbourbounds$SMA_MH_PC_Tot)
simulation_4.sma <- lag.listw(Neighbourbounds.w, simulation_4)
simulation_5 <- sample(Neighbourbounds$SMA_MH_PC_Tot)
simulation_5.sma <- lag.listw(Neighbourbounds.w, simulation_5)
#Add simulated landscapes to sf dataframe
Neighbourbounds$simulation_1 <- simulation_1
Neighbourbounds$simulation_2 <- simulation_2
Neighbourbounds$simulation_3 <- simulation_3
Neighbourbounds$simulation_4 <- simulation_4
Neighbourbounds$simulation_5 <- simulation_5
```

```{r}
#Add spatial moving averages to sf dataframe
Neighbourbounds$simulation_1.sma <- simulation_1.sma
Neighbourbounds$simulation_2.sma <- simulation_2.sma
Neighbourbounds$simulation_3.sma <- simulation_3.sma
Neighbourbounds$simulation_4.sma <- simulation_4.sma
Neighbourbounds$simulation_5.sma <- simulation_5.sma

#Create a new dataframe to compare original landscape to null landscapes
MH_PC_Tot2 <- Neighbourbounds %>% 
  # `transmute()` keeps only the spatial moving averages and geometry
  transmute(observed = MH_PC_Tot, 
         simulation_1,
         simulation_2,
         simulation_3,
         simulation_4,
         simulation_5,
         geometry) %>% 
  # `pivot_longer()` places all variables with the exception of `geometry` in a single column named `SMA` and creates a new variable called `VAR` with the names of the original columns (i.e., observed, simulation_1,...)
  pivot_longer(cols = -c(geometry, ends_with("sma")), names_to = "VAR", values_to = "values") %>%
  st_as_sf()

ggplot() + 
  geom_sf(data = MH_PC_Tot2, 
          aes(fill = values), color = NA) + 
  facet_wrap(~VAR, ncol = 3) +
  scale_fill_distiller(palette = "YlOrRd", direction = 1)+
  labs(fill = "Mental Health Cases per capita SMA") + 
  theme(axis.text.x = element_blank(), 
        axis.text.y = element_blank())

MH_PC_Tot2 <- MH_PC_Tot2 %>% 
  data.frame(Neighbourbounds %>% 
               st_drop_geometry() %>% # Drop the geometry because it is already available 
               # Select the original population density and the 5 null landscapes simulated from it.
               transmute(MHPCTot.sma,
                      simulation_1.sma,
                      simulation_2.sma,
                      simulation_3.sma,
                      simulation_4.sma,
                      simulation_5.sma,
               ) %>% # Pass the result to `pivot_longer()`  
               pivot_longer(cols = everything(), names_to = "VAR", values_to = "SMA") %>% # Copy all density variables to a single column, and create a new variable called `VAR` with the names of the original columns 
               select(SMA)) # Drop VAR from the the dataframe
```

Plots:
```{r}
ggplot(data = MH_PC_Tot2, 
       aes(x = values, 
           y = SMA,
           color = VAR)) +
  geom_point(alpha = 0.1) +
  geom_abline(slope = 1, intercept = 0, linetype = "dashed") +
  # Add a fitted line to the plots
  geom_smooth(formula = y ~ x,
              method = "lm") +
  coord_equal() +
  xlab("Mental Health Cases Per Capita") +
  ylab("Spatial Lag of Mental Health Cases Per Capita") +
  facet_wrap(~ VAR, ncol = 3)

Neighbourhood_centroids <- st_centroid(Neighbourbounds_Centroids) %>% 
  st_coordinates()

Neighbourhood_centroids_5min.dnb <- dnearneigh(Neighbourhood_centroids, d1 = 0, d2 = 410)
plot(Neighbourbounds.sp, border = "gray")
plot(Neighbourhood_centroids_5min.dnb, Neighbourhood_centroids, col = "red", add = TRUE)
summary(Neighbourhood_centroids_5min.dnb)

Neighbourhood_centroids_10min.dnb <- dnearneigh(Neighbourhood_centroids, d1 = 0, d2 = 826)
plot(Neighbourbounds.sp, border = "gray")
plot(Neighbourhood_centroids_10min.dnb, Neighbourhood_centroids, col = "red", add = TRUE)
summary(Neighbourhood_centroids_10min.dnb)

Neighbourhood_centroids_15min.dnb <- dnearneigh(Neighbourhood_centroids, d1 = 0, d2 = 1239)
plot(Neighbourbounds.sp, border = "gray")
plot(Neighbourhood_centroids_15min.dnb, Neighbourhood_centroids, col = "red", add = TRUE)
summary(Neighbourhood_centroids_15min.dnb)

Neighbourhood_centroids_30min.dnb <- dnearneigh(Neighbourhood_centroids, d1 = 0, d2 = 2580)
plot(Neighbourbounds.sp, border = "gray")
plot(Neighbourhood_centroids_30min.dnb, Neighbourhood_centroids, col = "red", add = TRUE)
summary(Neighbourhood_centroids_30min.dnb)

Neighbourhood_centroids_60min.dnb <- dnearneigh(Neighbourhood_centroids, d1 = 0, d2 = 5160)
plot(Neighbourbounds.sp, border = "gray")
plot(Neighbourhood_centroids_60min.dnb, Neighbourhood_centroids, col = "red", add = TRUE)
summary(Neighbourhood_centroids_60min.dnb)


# You will notice that the slope of the line tends to be flat in the simulated variables; this is to be expected, since these variables are spatially random the values of the variable at i are independent of the values of their local means in other words, the probability that the map is random is pretty high (in fact, since these 5 of these maps are null landscapes, we know for a fact that they are random).

#The empirical variable, on the other hand, has a slope that is much closer to the 45 degree line. This indicates that the values of the variable at i are not independent of their local mean the probability of a non-random pattern is high

# A spatial weights matrix is a representation of the spatial structure of your data. It is a quantification of the spatial relationships that exist among the features in your dataset (or, at least, a quantification of the way you conceptualize those relationships). Because the spatial weights matrix imposes a structure on your data, you should select a conceptualization that best reflects how features actually interact with each other. A spatial weights matrix was created for each established buffer to help understand the geographic distribution and to understand accessibility such as if you want to go to a different neighborhoods park. As seen by the maps and when we look at the summary tables, it isn't possible to access a different neighborhood in a 5 minute walking distance. other neighborhoods become accessible to the average walker when they go for a 30 to 60 minute walking trip.
```


Regression Model
```{r}

#5 minutes worth of green space
Neighbourbounds <- Neighbourbounds %>%
  mutate(Area_5_Transform = log10(Area_5min))

model5 <- lm(formula = MH_PC_Tot ~ Area_5_Transform, 
             data = Neighbourbounds)
summary(model5)

ggplot(data = Neighbourbounds, 
       aes(x = Area_5_Transform, 
           y = MH_PC_Tot))+
  geom_point() +
  geom_smooth(formula = y ~ x,
              method = "lm") +
  xlab("Green Space within 5 minutes of neighbourhood") +
  ylab("Mental Health Cases per Capita")


#10 minutes worth of green space
Neighbourbounds <- Neighbourbounds %>%
  mutate(Area_10_Transform = log10(Area_10min))

model10 <- lm(formula = MH_PC_Tot ~ Area_10_Transform, 
             data = Neighbourbounds)
summary(model10)

ggplot(data = Neighbourbounds, 
       aes(x = Area_10_Transform, 
           y = MH_PC_Tot))+
  geom_point() +
  geom_smooth(formula = y ~ x,
              method = "lm") +
  xlab("Green Space within 10 minutes of neighbourhood") +
  ylab("Mental Health Cases per Capita")



#15 minutes worth of green space
Neighbourbounds <- Neighbourbounds %>%
  mutate(Area_15_Transform = log10(Area_15min))

model15 <- lm(formula = MH_PC_Tot ~ Area_15_Transform, 
             data = Neighbourbounds)
summary(model15)

ggplot(data = Neighbourbounds, 
       aes(x = Area_15_Transform, 
           y = MH_PC_Tot))+
  geom_point() +
  geom_smooth(formula = y ~ x,
              method = "lm") +
  xlab("Green Space within 15 minutes of neighbourhood") +
  ylab("Mental Health Cases per Capita")

#30 minutes worth of green space
Neighbourbounds <- Neighbourbounds %>%
  mutate(Area_30_Transform = log10(Area_30min))

model30 <- lm(formula = MH_PC_Tot ~ Area_30_Transform, 
             data = Neighbourbounds)
summary(model30)

ggplot(data = Neighbourbounds, 
       aes(x = Area_30_Transform, 
           y = MH_PC_Tot))+
  geom_point() +
  geom_smooth(formula = y ~ x,
              method = "lm") +
  xlab("Green Space within 30 minutes of neighbourhood") +
  ylab("Mental Health Cases per Capita")


#60 minutes worth of green space
Neighbourbounds <- Neighbourbounds %>%
  mutate(Area_60_Transform = log10(Area_60min))

model60 <- lm(formula = MH_PC_Tot ~ Area_60_Transform, 
             data = Neighbourbounds)
summary(model60)

ggplot(data = Neighbourbounds, 
       aes(x = Area_60_Transform, 
           y = MH_PC_Tot))+
  geom_point() +
  geom_smooth(formula = y ~ x,
              method = "lm") +
  xlab("Green Space within 60 minutes of neighbourhood") +
  ylab("Mental Health Cases per Capita")
```

Linear Models including the other stuff

```{r}
Neighbourbounds <- Neighbourbounds %>%
  mutate(PropAge65Plus = (Age65to79 +Age80to99) / Census_Pop,
         PropAge45Plus = (Age45to54+ Age55to64+ Age65to79 +Age80to99) / Census_Pop,
         PropBelowPoverty = (Income_U5000 + Income_5000to9999 + Income_10000to14999 + Income_15000to19999 + Income_20000to29999 + Income_30000to39999 + Income_40000to49999)/Num_House,
         PropBelow20k = (Income_U5000 + Income_5000to9999 + Income_10000to14999 + Income_15000to19999)/Num_House)
```


```{r}
#Model is our best bet
modelBest <- lm(formula = MH_PC_Tot ~Area_5_Transform * Unemploy_r * Alone,  data = Neighbourbounds)
summary(modelBest)

modelBestM <- lm(formula = MH_PC_M ~Area_5_Transform,  data = Neighbourbounds)
summary(modelBestM)

modelBestF <- lm(formula = MH_PC_F ~Area_5_Transform,  data = Neighbourbounds)
summary(modelBestF)
```

```{r}
#Model including proportion of people below 50,000
model1 <- lm(formula = MH_PC_Tot ~ Area_5_Transform + Unemploy_r + Alone + PropBelowPoverty, data = Neighbourbounds)
summary(model1)


#Model including proportion of people below 20,000
model3 <- lm(formula = MH_PC_Tot ~ Area_5_Transform + Unemploy_r + Alone + PropBelow20k, data = Neighbourbounds)
summary(model3)

#Model including proportion of people over 65
model4 <- lm(formula = MH_PC_Tot ~ Area_5_Transform + Unemploy_r + Alone + PropAge65Plus, data = Neighbourbounds)
summary(model4)


#Model including proportion of people over 45
model4 <- lm(formula = MH_PC_Tot ~ Area_5_Transform + Unemploy_r + Alone + PropAge45Plus, data = Neighbourbounds)
summary(model4)


model2_10 <- lm(formula = MH_PC_Tot ~ Area_10_Transform + Unemploy_r + Alone,  data = Neighbourbounds)
summary(model2_10)

model2_15 <- lm(formula = MH_PC_Tot ~ Area_15_Transform + Unemploy_r + Alone,  data = Neighbourbounds)
summary(model2_15)

modelnotArea <- lm(formula = MH_PC_Tot ~  Unemploy_r + Alone,  data = Neighbourbounds)
summary(modelnotArea)
```

Create a plot with the model?



<!--This create a page break, i.e., starts a new page-->
<!--\newpage-->

<!-- 
To cite references in your bibliography.bib file, use [@item] if you want it to be cited in brackets, or @item if you want it to be cited as Name (year). If you want to cite various items in brackets, separate them with semicolons [@item1; @item2]
-->

<!--Use "#" for section headers-->




<!--Chunk option eval controls whether a chunk is evaluated when the document is executed; set to false to avoid running. It can still be manually run-->


<!--Chunk option echo controls whether the code is displayed in the output. The results of the chunk are displayed.
Chunk option fig.cap is used to give the figure a caption; we can add a label that we can refer to in the text as \ref{fig:counties-ky}, and then the figures will be automatically numbered.-->



# Results


<!--We can include inline calculations in the text by using r code as shown in the paragraph below-->


# Analysis



# Conclusion

# References
https://open.toronto.ca/
https://www12.statcan.gc.ca/census-recensement/2011/dp-pd/prof/details/page.cfm?Lang=E&Geo1=CMA&Code1=535&Geo2=PR&Code2=01&Data=Count&SearchText=Toronto&SearchType=Begins&SearchPR=01&B1=All&Custom=&TABID=1


